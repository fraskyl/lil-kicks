---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Baby Kick Counter">
  <main class="main">
    <header class="header">
      <h1 class="title">Lil' Kicks</h1>
      <p class="subtitle">Track your baby's movements</p>
    </header>

    <div class="kick-button-container">
      <button id="kickButton" class="kick-button disable-dbl-tap-zoom" aria-label="Record a kick">
        <span class="kick-text">Tap</span>
      </button>
      <div id="kickFeedback" class="kick-feedback"></div>
    </div>

    <div class="stats-card">
      <div class="stat-item">
        <span class="stat-label">Today</span>
        <span id="todayCount" class="stat-value">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">This Week</span>
        <span id="weekCount" class="stat-value">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">This Month</span>
        <span id="monthCount" class="stat-value">0</span>
      </div>
    </div>

    <nav class="nav-tabs">
      <div class="nav-tab-timeframe">
        <button class="nav-tab active" data-view="day">Day</button>
        <button class="nav-tab" data-view="week">Week</button>
        <button class="nav-tab" data-view="month">Month</button>
      </div>
      <div class="nav-button-analytics">
        <button class="nav-button" data-view="peak">Peak activity</button>
        <!-- not implemented average kicks yet -->
        <!-- <button class="nav-button" data-view="average">Average kicks</button> -->
      </div>
    </nav>

    <div id="historyView" class="history-view"></div>

    <!-- Modal for detailed kick times -->
    <div id="kickModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle" class="modal-title"></h3>
          <button id="modalClose" class="modal-close" aria-label="Close modal"
            >&times;</button
          >
        </div>
        <div class="modal-divider"></div>
        <div id="modalBody" class="modal-body"></div>
      </div>
    </div>
  </main>

  <style is:global>
    .header {
      text-align: center;
      margin-bottom: 2.5rem;
      padding-top: 1rem;
      animation: fadeInDown 0.6s ease-out;
    }

    .disable-dbl-tap-zoom {
      touch-action: manipulation;
    }

    .title {
      font-size: 2.5rem;
      color: var(--text-dark);
      margin-bottom: 0.25rem;
      line-height: 1.1;
    }

    .subtitle {
      font-size: 1rem;
      color: var(--text-dark);
      font-weight: 300;
      letter-spacing: 0.05em;
    }

    .main {
      animation: fadeInUp 0.6s ease-out 0.1s both;
    }

    .disable-dbl-tap-zoom {
      touch-action: manipulation;
    }

    .kick-button-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 2rem;
    }

    .kick-button {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: linear-gradient(
        135deg,
        var(--cyan) 0%,
        var(--cyan-light) 100%
      );
      border: none;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
    }

    .kick-button::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .kick-button:hover::before {
      opacity: 1;
    }

    .kick-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg);
    }

    .kick-button:active {
      transform: scale(0.95);
    }

    .kick-button.kicked {
      animation: kickPulse 0.6s ease-out;
    }

    .kick-text {
      color: var(--charcoal);
      font-family: "rucksack", sans-serif;
      font-weight: 700;
      font-size: 2rem;
      letter-spacing: 0.05em;
    }

    .kick-feedback {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      font-family: "rucksack", sans-serif;
      font-weight: 500;
      font-size: 1.5rem;
      color: var(--cyan);
      opacity: 0;
      display: none;
    }

    .kick-feedback.show {
      animation: feedbackPop 0.8s ease-out;
    }

    .stats-card {
      background: var(--warm-white);
      border-radius: 20px;
      padding: 1.75rem 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-sm);
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      border: 1px solid rgba(6, 216, 252, 0.1);
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--cyan-darker);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-family: "rucksack", sans-serif;
      font-weight: 500;
      font-size: 2rem;
      color: var(--charcoal);
      line-height: 1;
    }

    .nav-tabs {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      background: var(--warm-white);
      padding: 0.5rem;
      border-radius: 16px;
      box-shadow: var(--shadow-sm);
    }

    .nav-tab-timeframe {
      display: flex;
      flex: 1;
      gap: 0.5rem;
    }

    .nav-button-analytics {
      display: flex;
      flex: 1;
      gap: 0.5rem;
    }

    .nav-tab {
      flex: 1;
      padding: 0.75rem 1rem;
      border: none;
      background: transparent;
      color: var(--cyan-darker);
      font-size: 0.9rem;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: "rucksack", sans-serif;
      font-weight: 500;
      font-style: normal;
    }

    .nav-button {
      flex: 1;
      padding: 0.75rem 1rem;
      border: none;
      background: transparent;
      color: var(--cyan-darker);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: "rucksack", sans-serif;
      font-weight: 500;
      font-style: normal;
      border-radius: 0.75rem;
      border: solid 1px var(--cyan-light);
    }

    .nav-button:hover {
      background: var(--cyan-light);
    }

    /* Peak Activity Styles */
    .peak-activity-header {
      margin-bottom: 1.5rem;
    }

    .peak-highlight {
      background: linear-gradient(
        180deg,
        var(--cyan-light) 0%,
        var(--warm-white) 100%
      );
      border-radius: 16px;
      padding: 1.5rem;
      text-align: center;
      margin-top: 1rem;
      box-shadow: 0 4px 12px rgba(6, 216, 252, 0.25);
    }

    .peak-time {
      font-family: "Rucksack", sans-serif;
      font-size: 2.5rem;
      color: var(--charcoal);
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .peak-count {
      font-size: 1.1rem;
      color: var(--cyan-darker);
      font-weight: 500;
    }

    .hourly-breakdown {
      display: grid;
      margin-top: 1.5rem;
      gap: 1rem;
    }

    .peak-row {
      background: linear-gradient(
        90deg,
        rgba(6, 216, 252, 0.15) 0%,
        rgba(6, 216, 252, 0.05) 100%
      );
      border-left-width: 4px;
    }

    .nav-button.active {
      background: var(--cyan);
      color: var(--charcoal);
      box-shadow: 0 2px 8px rgba(6, 216, 252, 0.2);
    }

    .nav-tab:hover {
      background: rgba(6, 216, 252, 0.08);
    }

    .nav-tab.active {
      background: var(--cyan);
      color: var(--charcoal);
      box-shadow: 0 2px 8px rgba(6, 216, 252, 0.2);
    }

    .history-view {
      background: var(--warm-white);
      border-radius: 20px;
      padding: 1.5rem;
      min-height: 200px;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(6, 216, 252, 0.1);
    }

    .history-empty {
      text-align: center;
      color: var(--cyan-darker);
      padding: 3rem 1rem;
      font-style: italic;
    }

    .day-group {
      margin-bottom: 1.5rem;
    }

    .day-group:last-child {
      margin-bottom: 0;
    }

    .day-header {
      font-family: "rucksack", sans-serif;
      font-weight: 500;
      font-size: 1.1rem;
      color: var(--charcoal);
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--cyan-light);
    }

    .kicks-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .kick-item {
      background: linear-gradient(
        135deg,
        var(--cyan-light) 0%,
        var(--cyan) 100%
      );
      color: var(--charcoal);
      padding: 0.4rem 0.85rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(6, 216, 252, 0.15);
    }

    .week-summary,
    .month-summary {
      display: grid;
      gap: 0.75rem;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: linear-gradient(
        90deg,
        rgba(6, 216, 252, 0.06) 0%,
        transparent 100%
      );
      border-radius: 12px;
      border-left: 3px solid var(--cyan);
    }

    .summary-date {
      font-weight: 600;
      color: var(--charcoal);
    }

    .summary-count {
      font-family: "Rucksack", sans-serif;
      font-size: 1.5rem;
      color: var(--cyan-darker);
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes kickPulse {
      0%,
      100% {
        transform: scale(1);
      }
      25% {
        transform: scale(1.04);
      }
      50% {
        transform: scale(0.98);
      }
      75% {
        transform: scale(1.02);
      }
    }

    @keyframes feedbackPop {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5);
      }
      50% {
        opacity: 1;
        transform: translate(-50%, -150%) scale(1.2);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -200%) scale(1);
      }
    }

    @media (max-width: 480px) {
      .title {
        font-size: 2rem;
      }

      .kick-button {
        width: 180px;
        height: 180px;
      }

      .kick-text {
        font-size: 1.75rem;
      }

      .stats-card {
        padding: 1.5rem 1rem;
      }

      .stat-value {
        font-size: 1.75rem;
      }
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(10, 31, 40, 0.8);
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s ease-out;
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    // Storage key
    const STORAGE_KEY = "babyKicks";

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      background: linear-gradient(
        135deg,
        rgba(6, 216, 252, 0.05) 0%,
        transparent 100%
      );
    }

    .modal-divider {
      height: 1px;
      background: var(--cyan-light);
      margin-left: 1.5rem;
      margin-right: 1.5rem;
    }

    // Add a new kick
    function addKick(): void {
      const kicks = getKicks();
      const now = new Date();
      kicks.push({
        timestamp: now.toISOString(),
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        }),
      });
      saveKicks(kicks);
      updateStats();
      updateHistory();
    }

    // Get kicks for a specific date range
    function getKicksInRange(startDate: Date, endDate: Date): Kick[] {
      const kicks = getKicks();
      return kicks.filter((kick) => {
        const kickDate = new Date(kick.timestamp);
        return kickDate >= startDate && kickDate <= endDate;
      });
    }

    .modal-close:hover {
      background: var(--cyan-light);
      color: var(--charcoal);
    }

    .modal-body {
      padding: 1.5rem;
      overflow-y: auto;
      flex: 1;
    }

    .modal-kicks-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .modal-kick-item {
      background: linear-gradient(
        135deg,
        var(--cyan-light) 0%,
        var(--cyan) 100%
      );
      color: var(--charcoal);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(6, 216, 252, 0.15);
    }

    .modal-empty {
      text-align: center;
      color: var(--cyan-darker);
      padding: 2rem 1rem;
      font-style: italic;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 480px) {
      .modal-content {
        max-width: 95%;
        max-height: 85vh;
      }

      .modal-header {
        padding: 1.25rem;
      }

      .modal-body {
        padding: 1.25rem;
      }
    }
  </style>

  <script>
    import {
      getTimeOfDayPatterns,
      getPeakActivityHour,
      formatHour,
    } from "../lib/analytics/kick-pattern.js";

    import {
      getKicks,
      saveKicks,
      addKick,
      getKicksInRange,
      groupKicksByDate,
    } from "../lib/storage/kicks.js";

    import {
      openKickModal,
      closeKickModal,
      getKicksForHour,
      initializeModalHandlers,
    } from "../lib/ui/modal.js";

    // Types
    import type { Kick, KickGroup } from "../lib/storage/kicks.js";

    // Track current view state
    let currentView: "day" | "week" | "month" = "day";
    let isPeakViewActive = false;

    // Update statistics
    function updateStats(): void {
      const now = new Date();

      // Today
      const todayStart = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate(),
      );
      const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);
      const todayKicks = getKicksInRange(todayStart, todayEnd);

      // This week (last 7 days)
      const weekStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      const weekKicks = getKicksInRange(weekStart, now);

      // This month
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      const monthKicks = getKicksInRange(monthStart, now);

      const todayCountEl = document.getElementById("todayCount");
      const weekCountEl = document.getElementById("weekCount");
      const monthCountEl = document.getElementById("monthCount");

      if (todayCountEl) todayCountEl.textContent = String(todayKicks.length);
      if (weekCountEl) weekCountEl.textContent = String(weekKicks.length);
      if (monthCountEl) monthCountEl.textContent = String(monthKicks.length);
    }

    // Group kicks by date
    function groupKicksByDate(kicks: Kick[]): KickGroup {
      const groups: KickGroup = {};
      kicks.forEach((kick) => {
        if (!groups[kick.date]) {
          groups[kick.date] = [];
        }
        groups[kick.date].push(kick);
      });
      return groups;
    }

    // Update history view
    function updateHistory(): void {
      const view = currentView;
      const historyView = document.getElementById("historyView");
      if (!historyView) return;

      const now = new Date();

      if (view === "day") {
        // Show today's kicks with times
        const todayStart = new Date(
          now.getFullYear(),
          now.getMonth(),
          now.getDate(),
        );
        const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);
        const todayKicks = getKicksInRange(todayStart, todayEnd).reverse();

        if (todayKicks.length === 0) {
          historyView.innerHTML =
            '<div class="history-empty">No kicks recorded today yet</div>';
        } else {
          const kicksList = todayKicks
            .map((kick) => `<span class="kick-item">${kick.time}</span>`)
            .join("");
          historyView.innerHTML = `
            <div class="day-group">
              <div class="day-header">Today</div>
              <div class="kicks-list">${kicksList}</div>
            </div>
          `;
        }
      } else if (view === "week") {
        // Show last 7 days with counts
        const kicks = getKicks();
        const groups = groupKicksByDate(kicks);
        const last7Days: Array<{ date: string; count: number }> = [];

        for (let i = 6; i >= 0; i--) {
          const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
          const dateStr = date.toLocaleDateString();
          const dayName =
            i === 0
              ? "Today"
              : i === 1
                ? "Yesterday"
                : date.toLocaleDateString([], {
                    weekday: "short",
                    month: "short",
                    day: "numeric",
                  });
          const count = groups[dateStr] ? groups[dateStr].length : 0;
          last7Days.push({ date: dayName, count });
        }

        if (last7Days.every((day) => day.count === 0)) {
          historyView.innerHTML =
            '<div class="history-empty">No kicks recorded this week</div>';
        } else {
          const summaryHTML = last7Days
            .map(
              (day) => `
            <div class="summary-row">
              <span class="summary-date">${day.date}</span>
              <span class="summary-count">${day.count}</span>
            </div>
          `,
            )
            .join("");
          historyView.innerHTML = `<div class="week-summary">${summaryHTML}</div>`;

          // Add click event listeners to summary rows
          setTimeout(() => {
            const allKicks = getKicks();
            const kicksByDate = groupKicksByDate(allKicks);
            document
              .querySelectorAll(".week-summary .summary-row")
              .forEach((row, index) => {
                row.addEventListener("click", function (this: HTMLElement) {
                  const dayName =
                    this.querySelector(".summary-date")?.textContent || "";
                  let dateStr = "";

                  if (dayName === "Today") {
                    dateStr = now.toLocaleDateString();
                  } else if (dayName === "Yesterday") {
                    dateStr = new Date(
                      now.getTime() - 24 * 60 * 60 * 1000,
                    ).toLocaleDateString();
                  } else {
                    // For other days, match from last7Days array
                    const matchingDay = last7Days[index];
                    if (matchingDay) {
                      const d = new Date(
                        now.getTime() -
                          (6 - (index - (dayName === "Today" ? 0 : 1))) *
                            24 *
                            60 *
                            60 *
                            1000,
                      );
                      dateStr = d.toLocaleDateString();
                    }
                  }

                  if (dateStr && kicksByDate[dateStr]) {
                    openKickModal(`${dayName} Kicks`, kicksByDate[dateStr]);
                  } else {
                    openKickModal(`${dayName} Kicks`, []);
                  }
                });
              });
          }, 0);
        }
      } else if (view === "month") {
        // Show current month grouped by date
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const monthKicks = getKicksInRange(monthStart, now);
        const groups = groupKicksByDate(monthKicks);
        const sortedDates = Object.keys(groups).sort(
          (a, b) => new Date(b).getTime() - new Date(a).getTime(),
        );

        if (sortedDates.length === 0) {
          historyView.innerHTML =
            '<div class="history-empty">No kicks recorded this month</div>';
        } else {
          const summaryHTML = sortedDates
            .map((date) => {
              const dateObj = new Date(groups[date][0].timestamp);
              const dateStr = dateObj.toLocaleDateString([], {
                weekday: "short",
                month: "short",
                day: "numeric",
              });
              return `
              <div class="summary-row">
                <span class="summary-date">${dateStr}</span>
                <span class="summary-count">${groups[date].length}</span>
              </div>
            `;
            })
            .join("");
          historyView.innerHTML = `<div class="month-summary">${summaryHTML}</div>`;

          // Add click event listeners to summary rows
          setTimeout(() => {
            document
              .querySelectorAll(".month-summary .summary-row")
              .forEach((row) => {
                row.addEventListener("click", function (this: HTMLElement) {
                  const dateStr = this.dataset.date || "";
                  const dayName =
                    this.querySelector(".summary-date")?.textContent || "";
                  if (dateStr && groups[dateStr]) {
                    openKickModal(`${dayName} Kicks`, groups[dateStr]);
                  } else {
                    openKickModal(`${dayName} Kicks`, []);
                  }
                });
              });
          }, 0);
        }
      }
    }
    // Handle kick button click
    let currentView: "day" | "week" | "month" = "day";

    const kickButton = document.getElementById("kickButton");
    if (kickButton) {
      kickButton.addEventListener("click", function () {
        this.classList.add("kicked");
        setTimeout(() => this.classList.remove("kicked"), 600);

        addKick();

        // Haptic feedback if available
        if ("vibrate" in navigator) {
          navigator.vibrate(50);
        }
      });
    }

    // Handle view tabs
    document.querySelectorAll(".nav-tab").forEach((tab) => {
      tab.addEventListener("click", function (this: HTMLElement) {
        document
          .querySelectorAll(".nav-tab")
          .forEach((t) => t.classList.remove("active"));
        this.classList.add("active");
        const view = this.dataset.view;
        if (view === "day" || view === "week" || view === "month") {
          currentView = view;

          if (isPeakViewActive) {
            showPeakActivity();
          } else {
            updateHistory();
          }
        }
      });
    });

    // Handle analytics buttons
    document.querySelectorAll(".nav-button").forEach((button) => {
      button.addEventListener("click", function (this: HTMLElement) {
        const view = this.dataset.view;

        if (view === "peak") {
          // if already active, deactivate
          if (isPeakViewActive) {
            isPeakViewActive = false;
            this.classList.remove("active");
            updateHistory();
          } else {
            // Activate peak view
            isPeakViewActive = true;

            // Remove active class from ALL nav-buttons
            document.querySelectorAll(".nav-button").forEach((btn) => {
              btn.classList.remove("active");
            });

            // Add active class to this button
            this.classList.add("active");
            showPeakActivity();
          }
        } else if (view === "average") {
          // For now, just deactivate peak view if active
          isPeakViewActive = false;
          console.log("Average kicks view not implemented yet.");
        }
      });
    });

    // Initialize on page load
    updateStats();
    updateHistory();
    initializeModalHandlers();
  </script>
</Layout>
